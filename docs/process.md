# 検討過程

## サマリ
- pix2pix ベースでフォント補完を行う実装を採用。
- 学習データは参考フォントとターゲットフォントのペア画像。
- モデルは U-Net ジェネレータと PatchGAN 識別器で構成。
- 今後はより深いモデルやストローク一貫性を考慮した損失導入を検討。


## 検討過程記録

このファイルには本リポジトリの実装方針を検討した内容を簡単に記録します。

### PR #4
1. 参考フォントと既存フォントのペア画像を作成することで pix2pix 形式の学習が可能と判断。
2. モデルは U-Net ジェネレータと PatchGAN 識別器を採用し、実装をシンプルに保つ。
3. 学習では GAN 損失に加えて L1 損失を大きめに掛けることで画素の一致度を高める。
4. 生成した PNG からフォントデータへ変換する手順も検討し、FontForge などの自動トレースを想定。

今後はモデルの改良やデータ拡張などを試し、品質向上を目指す予定です。

### PR #6
1. 文字リストとフォントパスから学習用画像を自動生成する機能を追加。
2. 推論時に一時ファイルを使わずメモリ上で画像を処理するよう改善。
3. ドキュメントを更新し、学習・推論フローを整理。

### PR #7
1. 2 段階学習とデータ増強に対応するため `stagewise_train` を実装。
2. 画像前処理としてランダムアフィン変換、ノイズ付与、太さ変化を選択可能にした。
3. ドキュメントを整理し、学習戦略を `training_strategy.md` として追加。

### PR #8
1. Perceptual Loss と層凍結を追加し、2 段階学習の忘却を軽減。
2. データ増強を参考フォントとターゲットで別々に適用できるよう改善。
3. 高解像度学習のメリットと注意点を `high_resolution.md` に整理。

### PR #9
1. ドキュメントの誤記を修正し、データセット変換の仕様を整理。
2. ヘッダのメタ情報を更新。

### PR #10
1. 512px 学習へ拡張するため画像サイズと U-Net 段数をパラメータ化。
2. `torch.cuda.amp` を用いて混合精度学習に対応。
3. データセットに個別 Transform とリサイズ処理を追加し、リハーサル戦略を強化。
4. ドキュメントを更新し、高解像度学習の手順を追記。

### PR #11
1. VGG Perceptual Loss を多層化し、PSNR/SSIM の定量評価を追加。
2. `CosineAnnealingLR` による学習率スケジュールを導入。
3. これらに合わせてドキュメントを整理し、学習戦略へ定量評価の章を追記。

### PR #12
1. SciPy を利用した太さシフト変換をデータ増強に追加。
2. InstanceNorm と BatchNorm を切り替え可能にし、スタイル保持を改善。
3. ドキュメントを追補し、実装の選択肢を明確化。

### PR #13
1. `log_memory` で GPU メモリ使用量を記録できるよう改良。
2. YAML 形式の設定ファイルを読み込む `train_from_config` を追加。
3. ドキュメントにデータセットバランスとベクトル化の注意点を追記。

### PR #14
1. 環境構築手順をまとめた `installation.md` を新設し、`index.md` からリンクを追加。
2. 既存ドキュメントを整理して導入までの流れを明確化。
3. 256px 事前学習と 512px プログレッシブ学習を自動化する `train_pix2pix_pro.py` を追加。
4. ドキュメントを整理し、新スクリプトの使用方法を追記。

### version: 1.0.41 (PR #15)
1. `train_pix2pix_pro.py` の初期設定を整理し、フォントパスを `fonts/` 配下に統一。
2. コード機能の概要をまとめた `docs/code_overview.md` を追加し、`index.md` から参照できるようにした。
3. スクリプトのドックストリングでバージョン情報を更新。
### version: 1.0.43 (PR #17)
1. 外部ファイルまたはフォント自動判定から学習文字を生成する仕組みを追加。
2. `train_pix2pix_pro.py` に新しい関数を統合し設定を更新。
3. ドキュメントに学習文字リストの管理方法をまとめた `character_list.md` を追加。

### version: 1.0.44 (PR #18)
1. `tqdm` による進捗バーと TensorBoard 画像保存に対応。
2. 重み初期化関数を導入し、モデルロードがない場合に適用。
3. Stage2 で既存文字を少量混ぜるリハーサル戦略オプションを追加。
4. 主要設定を `argparse` から指定できる CLI を実装。
5. ドキュメントを整理し、新機能の使い方を追記。

### version: 1.0.45 (PR #19)
1. 乱数シード固定関数を追加し、学習冒頭で呼び出すように変更。
2. 実行設定を TensorBoard に保存する処理を導入。
3. 再現性とデバッグのポイントをまとめた `reproducibility.md` を新設し、`index.md` から参照できるようにした。

### version: 1.0.46 (PR #20)
1. 検証データセットを導入し、PSNR が向上した際のみモデルを `G_best.pth` として保存する機能を追加。
2. 勾配クリッピングと GPU メモリのロギングを実装し、学習の安定性とデバッグ性を向上。
3. すべての実行設定を `config.json` に書き出し、実験ごとの再現が容易になった。

### version: 1.0.47 (PR #21)
1. 太さ変化を確率的に適用する `RandomApply` を利用し、データ増強を強化。
2. `DataLoader` で `pin_memory=True` を設定し、転送コストを削減。
3. 勾配クリッピング値を設定から変更できるようにし、柔軟性を向上。
4. ドキュメントを更新し、新しいオプションを `index.md` に反映。

### version: 1.0.50 (PR #22)
1. 学習文字の生成処理を拡張し、``--include_chars`` ``--exclude_chars``
   ``--range_start`` ``--range_end`` を指定可能にした。
2. ベースフォントと参考フォントの両方で空白となるグリフを除外する
   フィルタを追加。
3. `character_list.md` と `index.md` を更新し、文字セットの柔軟な設定方法を解説。

### version: 1.0.60 (PR #27)
1. 骨格画像を生成する `scripts/prepare_skeleton_data.py` を追加。
2. `train_pix2pix_pro.py` に ``--skeleton_dir`` オプションと対応データセット処理を実装。
3. ドキュメントに骨格入力の仕組みを追記し、ストローク構造を意識した学習方法を整理。

### version: 1.0.62 (PR #28)
1. 骨格生成処理にGaussianブラーとOtsu二値化を追加しノイズを除去。
2. `FontPairDataset` が骨格画像用Transformを受け取り2チャネル学習を柔軟化。
3. ドキュメントを整理し `skeleton_approach.md` を新設。

### version: 1.0.64 (PR #29)
1. Discriminator の入力チャネルを `[ske,ref]` + `[real/fake]` の3chに修正。
2. 生成画像の細線化結果と骨格画像で L1 損失を計算する ``stroke_lambda`` を追加。
3. `scripts/prepare_skeleton_data.py` に ``--no_blur`` オプションを導入し前処理を選択可能に。
4. ドキュメント `index.md` に新機能を追記。

### version: 1.0.65 (PR #30)
1. 骨格画像を .pt テンソルとして保存し `torch.load` で高速読み込みを実現。
2. Sobel フィルタによる GPU ストローク損失とコサイン減衰スケジュールを導入。
3. Discriminator 入力に微小ノイズを加え過学習を抑制。

### version: 1.0.68 (PR #31)
1. 参考・ターゲット・骨格をまとめた `.pt` データを作成する `prepare_data_step1_5.py` を追加。
2. `train_pix2pix_pro.py` が `--preprocessed_dir` で高速ローダーを利用可能に。
3. 検証指標として Edge IoU を追加しストローク再現度を定量化。

### version: 1.0.70 (PR #32)
1. `PreprocessedFontDataset` が mmap 読み込みに対応し、メモリ効率を向上。
2. 骨格損失をエッジ面積で正規化し、入力ノイズをエポックごとに減衰。
3. 検証時に Mean_Edge_Width を記録し、ストロークの太さ誤差を把握可能に。

### version: 1.0.72 (PR #33)
1. `prepare_data_step1_5.py` がエッジ面積を保存し、`calculate_stats.py` で平均値を算出。
2. `train_pix2pix_pro.py` は層化サンプリングで検証データを抽出し、`--use_compile` で `torch.compile` を試行可能に。
3. ドキュメントに高度なワークフローを追記。


